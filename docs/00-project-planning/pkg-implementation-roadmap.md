# PKG DAGアーキテクチャ実装ロードマップ

## 概要
確立されたPKG DAGアーキテクチャを実際のトレーディングシステムに反映させるための段階的実装計画。

## 現在の状況
✅ **完了済み**
- PKG DAGアーキテクチャ設計
- 4段階DAG構成の定義
- PKGルール（横参照禁止）の文書化
- 統一PKG ID体系の設計
- 基本的なPKG実装（`trading_signal_pkg.py`）

## フェーズ1: 基盤整備（Week 1-2）

### 1.1 既存コードのリファクタリング
**目的**: 現在の実装をPKGアーキテクチャに合わせる

#### タスク
- [ ] 既存のメモロジック実装を4段階DAGに再構成
- [ ] 横参照を排除し、階層的依存に変更
- [ ] PKG ID体系を全モジュールに適用

#### 対象ファイル
```
src/pkg/memo_logic/*.py → PKG準拠に変更
src/operation_logic/key_concepts.py → 素材DAGに統合
src/indicators/base_indicators.py → 素材DAGの一部として再構成
```

#### 成果物
- [ ] `src/pkg/feature_dag/` - 素材DAGの実装
- [ ] `src/pkg/decision_dag/` - 判定DAGの実装
- [ ] `src/pkg/financial_dag/` - 財務DAGの実装
- [ ] `src/pkg/trading_dag/` - 取引DAGの実装

### 1.2 テスト基盤の構築
**目的**: PKG DAGの動作を保証するテスト環境

#### タスク
- [ ] 各DAGレイヤーの単体テスト作成
- [ ] DAG間のインターフェーステスト
- [ ] パフォーマンステスト（30ms以内の応答）

#### 成果物
- [ ] `tests/pkg/test_feature_dag.py`
- [ ] `tests/pkg/test_decision_dag.py`
- [ ] `tests/pkg/test_financial_dag.py`
- [ ] `tests/pkg/test_trading_dag.py`
- [ ] `tests/pkg/test_dag_integration.py`

## フェーズ2: 素材DAG実装（Week 3-4）

### 2.1 データ収集層
**目的**: 全時間足共通の特徴量抽出

#### タスク
- [ ] ティックデータ処理
- [ ] マルチタイムフレームデータの正規化
- [ ] リアルタイムデータストリーム統合

#### 実装内容
```python
# src/pkg/feature_dag/data_collection.py
class DataCollectionLayer:
    """階層0: 生データ収集"""
    - ティックデータ受信
    - OHLCV生成
    - ボリューム集計
```

### 2.2 特徴量計算層
**目的**: テクニカル指標と派生データの計算

#### タスク
- [ ] 平均足計算の統合
- [ ] レンジ幅・変化率計算
- [ ] 乖離指標の実装

#### 実装内容
```python
# src/pkg/feature_dag/feature_extraction.py
class FeatureExtractionLayer:
    """階層1-5: 特徴量抽出"""
    - 基本指標（階層1）
    - 複合指標（階層2-3）
    - マルチタイムフレーム統合（階層4）
    - エクスポート層（階層5）
```

### 2.3 エクスポート契約
**目的**: 判定DAGへの標準化されたデータ提供

#### タスク
- [ ] エクスポートスキーマの実装
- [ ] データ品質チェック
- [ ] バージョニング機構

## フェーズ3: 判定DAG群実装（Week 5-6）

### 3.1 時間足別判定DAG
**目的**: 各時間足での独立した判定ロジック

#### タスク
- [ ] 1分足判定DAG（スキャルピング）
- [ ] 5分足判定DAG（短期）
- [ ] 15分足判定DAG（メイン）
- [ ] 1時間足判定DAG（中期）
- [ ] 4時間足判定DAG（長期）

#### 実装内容
```python
# src/pkg/decision_dag/timeframe_decisions/
m1_decision_dag.py   # 階層20-29
m5_decision_dag.py   # 階層30-39
m15_decision_dag.py  # 階層40-49
h1_decision_dag.py   # 階層50-59
h4_decision_dag.py   # 階層60-69
```

### 3.2 判定ロジックの移植
**目的**: メモファイルのロジックをPKG形式で実装

#### タスク
- [ ] もみ判定の実装
- [ ] 同逆判定の実装
- [ ] 行帰パターンの実装
- [ ] ブレイクアウト判定の実装

### 3.3 シグナル生成
**目的**: 各時間足からの統一シグナル出力

#### タスク
- [ ] シグナル強度計算
- [ ] 信頼度スコア
- [ ] 有効期限管理

## フェーズ4: 財務DAG実装（Week 7）

### 4.1 リスク管理層
**目的**: ポートフォリオ全体のリスク評価

#### タスク
- [ ] VAR（Value at Risk）計算
- [ ] 最大ドローダウン管理
- [ ] 相関リスク評価

#### 実装内容
```python
# src/pkg/financial_dag/risk_management.py
class RiskManagementLayer:
    """階層100-101: リスク評価"""
    - ポートフォリオ状態取得
    - 現在リスク計算
    - リスク許容度判定
```

### 4.2 ポジションサイジング
**目的**: 最適な取引サイズの決定

#### タスク
- [ ] Kelly基準の実装
- [ ] 固定比率法
- [ ] ボラティリティ調整

### 4.3 執行パラメータ
**目的**: SL/TPレベルの決定

#### タスク
- [ ] ATRベースのストップロス
- [ ] リスクリワード比の最適化
- [ ] トレーリングストップ

## フェーズ5: 取引DAG実装（Week 8）

### 5.1 シグナル統合
**目的**: 複数時間足シグナルの統合

#### タスク
- [ ] シグナル収集機構
- [ ] 整合性チェック
- [ ] 優先順位判定（MN関数）

#### 実装内容
```python
# src/pkg/trading_dag/signal_integration.py
class SignalIntegrationLayer:
    """階層200-202: シグナル統合"""
    - 時間足シグナル収集
    - アライメントスコア計算
    - 優先シグナル選択
```

### 5.2 財務制約適用
**目的**: リスク管理ルールの適用

#### タスク
- [ ] 財務DAGとの統合
- [ ] 執行可否判定
- [ ] 最終執行指示生成

### 5.3 執行インターフェース
**目的**: ブローカーAPIとの接続

#### タスク
- [ ] 執行指示のフォーマット
- [ ] オーダー管理
- [ ] エラーハンドリング

## フェーズ6: バックテスト最適化（Week 9-10）

### 6.1 バックテスト環境
**目的**: PKG DAGの性能評価

#### タスク
- [ ] ヒストリカルデータでの評価
- [ ] 各DAGレイヤーの性能測定
- [ ] ボトルネック分析

### 6.2 AIエージェント統合
**目的**: DAG構造の探索と最適化

#### タスク
- [ ] Mastra探索エージェントの実装
- [ ] DAG構造探索パイプライン
- [ ] パラメータ最適化

#### 実装内容
```python
# src/optimization/dag_explorer.py
class DAGExplorerAgent:
    """DAG構造探索エージェント"""
    - 構造提案（ノード追加/削除）
    - パラメータ範囲提案
    - バックテスト評価
```

### 6.3 最適化パイプライン
**目的**: 継続的な改善プロセス

#### タスク
- [ ] 探索フェーズの自動化
- [ ] バックテスト結果の分析
- [ ] 本番環境への適用

## フェーズ7: 本番環境準備（Week 11-12）

### 7.1 パフォーマンス最適化
**目的**: 30ms以内の応答時間達成

#### タスク
- [ ] プロファイリング実施
- [ ] ボトルネック解消
- [ ] 並列処理の実装
- [ ] キャッシュ戦略

### 7.2 監視・ログ
**目的**: 本番環境での可観測性

#### タスク
- [ ] メトリクス収集
- [ ] ログ体系の整備
- [ ] アラート設定
- [ ] ダッシュボード構築

### 7.3 デプロイメント
**目的**: 安全な本番環境移行

#### タスク
- [ ] ステージング環境でのテスト
- [ ] ブルー/グリーンデプロイメント
- [ ] ロールバック計画
- [ ] 本番モニタリング

## マイルストーン

| フェーズ | 期間 | 主要成果物 | 成功基準 |
|---------|------|-----------|----------|
| フェーズ1 | Week 1-2 | 基盤整備完了 | 全コードがPKG準拠 |
| フェーズ2 | Week 3-4 | 素材DAG稼働 | 特徴量抽出成功 |
| フェーズ3 | Week 5-6 | 判定DAG群稼働 | 全時間足でシグナル生成 |
| フェーズ4 | Week 7 | 財務DAG稼働 | リスク管理機能 |
| フェーズ5 | Week 8 | 取引DAG稼働 | 統合シグナル生成 |
| フェーズ6 | Week 9-10 | 最適化完了 | Sharpe比改善 |
| フェーズ7 | Week 11-12 | 本番稼働 | 安定運用開始 |

## リスクと対策

### 技術的リスク
| リスク | 影響 | 対策 |
|--------|------|------|
| 応答時間30ms超過 | 取引機会損失 | 並列処理、キャッシュ最適化 |
| DAG間の不整合 | 誤シグナル | 契約テスト、インターフェース検証 |
| メモリ使用量増大 | システム不安定 | ストリーミング処理、GC最適化 |

### ビジネスリスク
| リスク | 影響 | 対策 |
|--------|------|------|
| バックテスト過学習 | 本番での性能低下 | ウォークフォワード分析 |
| 市場環境変化 | 戦略の陳腐化 | 適応的パラメータ調整 |
| 規制変更 | 取引制限 | コンプライアンス監視 |

## 成功指標（KPI）

### 技術指標
- [ ] 応答時間: 95パーセンタイル < 30ms
- [ ] 可用性: 99.9%以上
- [ ] エラー率: 0.1%未満
- [ ] テストカバレッジ: 80%以上

### ビジネス指標
- [ ] Sharpe比: 1.5以上
- [ ] 最大ドローダウン: 10%以内
- [ ] 勝率: 55%以上
- [ ] プロフィットファクター: 1.3以上

## チェックポイント

### 週次レビュー
- 進捗確認
- 課題の特定と解決
- 次週の計画調整

### フェーズ完了レビュー
- 成果物の検証
- KPI達成度評価
- 次フェーズへの移行判断

## 必要リソース

### 開発環境
- Python 3.11+
- PostgreSQL/TimescaleDB
- Redis（キャッシュ）
- Docker/Kubernetes

### 外部サービス
- OANDA API（デモ/本番）
- GitHub Actions（CI/CD）
- Cloudflare（インフラ）
- Mastra（AI探索）

### データ
- 5年分のヒストリカルデータ
- リアルタイムティックデータ
- 経済指標カレンダー

## 次のアクション

### 即座に開始（Week 1）
1. [ ] 既存コードの監査
2. [ ] PKG準拠チェックリスト作成
3. [ ] リファクタリング計画詳細化
4. [ ] テスト環境セットアップ

### 準備が必要（Week 2以降）
1. [ ] 各DAGの詳細設計書作成
2. [ ] パフォーマンステスト環境構築
3. [ ] AIエージェント環境準備
4. [ ] 本番環境の設計

---

作成日: 2025年1月
バージョン: 1.0.0