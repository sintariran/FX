# パッケージ管理

## 📋 概要

パッケージ管理システムは、エクセル関数のパッケージ化と階層構造の最適化を通じて、効率的なデータ処理と取引ロジックの実装を実現します。

## 🎯 エクセル関数のパッケージ照合

### 処理の課題
- **数式を分割して、関数を抜き出す処理に4〜6時間**
- **母数が多い42,000件のデータ**
- **該当条件のルートIDを絞り込む処理（フィルタリング関数）**

### 処理遅延の要因
1. 自分自身が素材
2. 素材の区分の重複
3. 範囲指定する箇所がパッケージ化できていない
4. 前提はあるが、範囲指定
5. 見つからないがほとんどになっている → 新規作成が多い

### データ構造
- **エクセルA列**: 関数行番号
- **エクセルD列**: ルートID
- **全部1,5,15,30,60,240が成立しているルートID**

## 📊 関数フォーマット定義

### MATCHのフォーマット
**2ステップ構成**

#### ステップ1（範囲指定のルートIDと条件1のルートIDの一致判定）
- **タイプ**: X2
- **処理**: 条件1と範囲指定のルートIDの一致を確認（出力3のルートIDを取得）

#### ステップ2（一致判定結果に基づく出力値の選定）
- **タイプ**: SL
- **行数**: 範囲指定の行数分用意
- **出力値**: 範囲指定の行番号（1〜n）191^1〜191^n
- **条件**: タイプX2の出力値が3のルートIDを各範囲指定の行数別に指定

### INDEXのフォーマット
- **タイプ**: SL
- **行数**: 範囲指定の行数分用意
- **出力値**: 範囲指定の行ごとのルートIDの出力値
- **条件**: 行／列の固定値でない側の出力値（1〜n）に応じたルートIDを行番号に合わせて設定

### sumのフォーマット
- **タイプ**: Zの1（複数回実行）
- **用途**: 加速の合算処理のみ
- **処理**: 素材の指定範囲から素材を順番に積算する

### modのフォーマット
- **タイプ**: Z(8)
- **引数1**: 条件1に設定
- **引数2**: 条件2に設定

### O1参照（O$1）参照のフォーマット
- **タイプ**: ND
- **備考**: 191^1-3150で作成済み

### minuteのフォーマット
- **タイプ**: MN
- **引数1**: 条件1に設定

### ROUNDDOWNのフォーマット
**2ステップ構成**

#### ステップ1（材料から0.49999を引く）
- **タイプ**: Z(2)
- **条件1**: 引数
- **条件2**: 191^0.49999

#### ステップ2（四捨五入処理）
- **タイプ**: RO
- **条件1**: ステップ1の結果

### countaのフォーマット
- **タイプ**: U
- **出力値**: 範囲指定の要素数（固定値として出力可）

### min/maxのフォーマット
- **備考**: パッケージ機能として未実装のため、イエに直接組み込み（表示器用）

### averageのフォーマット
- **備考**: リアルで処理できないため、対象から外す

### offset
- **備考**: 範囲指定のみの機能のため、パッケージ化しない（使用箇所も1か所のみ）

## 🏗️ グループ階層数調整

### 取引条件の階層化

#### エントリー制限
1. **前足の平均足が陰線になっていなければ、エントリーしない**
2. **先足が返してきていない状態で前足まで逆方向に転換したら、決済する**
3. **先先足もエントリー制限に追加**
4. **エントリー制限から前足と今足の周期の揃いがある場合除外条件を解除する**

#### 決済条件
1. **平均足／OPFFが転換している場合は、その時間足のOPFと前足以前のOPFFが転換するまで決済しない**
2. **先足以降での周期の揃いが成立している箇所では入らない**
3. **1分の揃いと前足以前のOPFFの揃い**

### 3パターンの分岐式
各状況での分岐要素：
- 行帰戻
- 転換足
- 周期の揃いのタイミング
- 周期の方向揃い
- 平足の始値に対する実勢の位置
- 平足に対するO指標の同逆

### 時間結合の役割
- **他時間足の動きを用いて、オーバーシュート、多段の判断を行う**
- **どの時刻のどの時間足を見るかを特定する**

### 取引の絞り込み要素
1. **乖離／確認ポイント**
2. **平均足の陰陽揃い**
3. **オーバーシュート成立**
   - 下方向転換：前足／前々足での逆方向オーバーシュート
4. **オペレーションとして、加速ポイントの導出（OP）**
5. **時間足の接続点において決済をする（取引）**

## 📈 パフォーマンス統計

### 各処理の実行時間（ミリ秒）
- **全体**: 19 (-100)
- **単一周期Os**: 52.5 (-200)
- **周期揃い**: 52.8 (-300)
- **転換足**: 64 (-400)
- **もみ**: 77 (-500) ●
- **S_周期**: 66.2 (-600) ●
- **S_周期解除**: 81 (-700)
- **OP分岐**: 101.3 (-800) ●
- **オーバーシュート**: 550.6 (-900) ●
- **OP1M**: 527.2 (-1000) ●
- **時間結合**: 564.9 (-1000)
- **追加**: 589.4 (-1100) ●
- **ヘッジ**: 590.2 (-1200)
- **ヘッジ決済**: 590.2 (-1300)

## 🔧 最適化の方向性

### 処理効率の改善
1. **パッケージ化の推進**
2. **重複処理の削減**
3. **並列処理の活用**

### 階層構造の最適化
1. **依存関係の整理**
2. **処理順序の最適化**
3. **キャッシュの活用**

---

## 📅 出典
- **ファイル**: 20200514_エクセル関数のパッケージ照合.txt（2020年5月14日）
- **ファイル**: 20200731_グループ階層数調整.txt（2020年7月31日）
- **カテゴリ**: システム実装・データ管理