# PKGæº–æ‹ ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

## ğŸ¯ ç›®çš„
æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã‚’PKG DAGã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã«æº–æ‹ ã•ã›ã‚‹ãŸã‚ã®è©³ç´°ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

## âœ… PKGæº–æ‹ ãƒã‚§ãƒƒã‚¯é …ç›®

### 1. éšå±¤å‚ç…§ãƒ«ãƒ¼ãƒ«
- [ ] **æ¨ªå‚ç…§ã®å®Œå…¨æ’é™¤**
  - [ ] åŒã˜éšå±¤å†…ã®ãƒãƒ¼ãƒ‰é–“å‚ç…§ãŒãªã„ã‹ç¢ºèª
  - [ ] å„é–¢æ•°ãŒä¸‹ä½éšå±¤ã®ã¿ã‚’å‚ç…§ã—ã¦ã„ã‚‹ã‹ç¢ºèª
  - [ ] ä¾å­˜é–¢ä¿‚ã‚°ãƒ©ãƒ•ã«ã‚µã‚¤ã‚¯ãƒ«ãŒãªã„ã‹ç¢ºèª

- [ ] **éšå±¤ã®æ˜ç¢ºåŒ–**
  - [ ] å„ãƒãƒ¼ãƒ‰ã®éšå±¤ãƒ¬ãƒ™ãƒ«ãŒæ˜ç¢ºã«å®šç¾©ã•ã‚Œã¦ã„ã‚‹ã‹
  - [ ] éšå±¤0ï¼ˆç”Ÿãƒ‡ãƒ¼ã‚¿ï¼‰ã‹ã‚‰ä¸Šä½éšå±¤ã¸ã®æµã‚ŒãŒä¸€æ–¹å‘ã‹
  - [ ] éšå±¤NãŒéšå±¤N-1ä»¥ä¸‹ã®ã¿ã‚’å‚ç…§ã—ã¦ã„ã‚‹ã‹

### 2. ã‚¹ãƒ†ãƒ¼ãƒˆãƒ¬ã‚¹å®Ÿè£…
- [ ] **ç´”ç²‹é–¢æ•°ã¸ã®å¤‰æ›**
  - [ ] ã‚¯ãƒ©ã‚¹ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹å¤‰æ•°ã«ã‚ˆã‚‹ã‚¹ãƒ†ãƒ¼ãƒˆä¿æŒã‚’æ’é™¤
  - [ ] é–¢æ•°ã®æˆ»ã‚Šå€¤ãŒå…¥åŠ›ã®ã¿ã«ä¾å­˜
  - [ ] åŒã˜å…¥åŠ›ã§å¿…ãšåŒã˜å‡ºåŠ›ã‚’ç”Ÿæˆ

```python
# âŒ ã‚¹ãƒ†ãƒ¼ãƒˆãƒ•ãƒ«ï¼ˆå¤‰æ›´å‰ï¼‰
class BadExample:
    def __init__(self):
        self.cache = {}
    
    def process(self, data):
        self.cache[data.id] = data  # çŠ¶æ…‹å¤‰æ›´
        return self.some_calculation()

# âœ… ã‚¹ãƒ†ãƒ¼ãƒˆãƒ¬ã‚¹ï¼ˆå¤‰æ›´å¾Œï¼‰
def good_example(data: Dict, cache: Dict) -> Tuple[Result, Dict]:
    new_cache = {**cache, data['id']: data}
    result = calculate_something(data)
    return result, new_cache
```

### 3. PKG IDä½“ç³»ã®çµ±ä¸€
- [ ] **IDå½¢å¼ã®ç¢ºèª**
  - [ ] `[æ™‚é–“è¶³][å‘¨æœŸ][é€šè²¨]^[éšå±¤]-[é€£ç•ª]` å½¢å¼ã«æº–æ‹ 
  - [ ] æ—§è¨˜å·ä½“ç³»ï¼ˆAA001, AB301ç­‰ï¼‰ã‹ã‚‰ã®ç§»è¡Œå®Œäº†
  - [ ] å…¨ãƒãƒ¼ãƒ‰ã®IDãŒä¸€æ„ã§é‡è¤‡ãªã—

```python
# âŒ æ—§å½¢å¼
AA001 = "ç¾åœ¨ä¾¡æ ¼"
AB301 = "å¹³å‡è¶³å§‹å€¤"

# âœ… æ–°å½¢å¼
391^0-001 = "ç¾åœ¨ä¾¡æ ¼"
391^0-101 = "å¹³å‡è¶³å§‹å€¤"
```

### 4. é–¢æ•°å®šç¾©ã®æ¨™æº–åŒ–
- [ ] **é–¢æ•°ã‚·ã‚°ãƒãƒãƒ£**
  - [ ] å…¥åŠ›ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒæ˜ç¢ºã«å‹å®šç¾©ã•ã‚Œã¦ã„ã‚‹
  - [ ] æˆ»ã‚Šå€¤ã®å‹ãŒæ˜ç¢º
  - [ ] ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ–‡å­—åˆ—ã§æ©Ÿèƒ½èª¬æ˜

```python
# âœ… æ¨™æº–åŒ–ã•ã‚ŒãŸé–¢æ•°å®šç¾©
def pkg_node_391_1_001(
    raw_data: Dict[str, float],
    context: Dict[str, Any]
) -> Tuple[float, Dict[str, Any]]:
    """
    391^1-001: ã‚‚ã¿åˆ¤å®šãƒãƒ¼ãƒ‰
    
    Args:
        raw_data: ç”Ÿãƒ‡ãƒ¼ã‚¿ï¼ˆãƒ¬ãƒ³ã‚¸å¹…ç­‰ï¼‰
        context: å®Ÿè¡Œã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
        
    Returns:
        (åˆ¤å®šçµæœ, æ›´æ–°ã•ã‚ŒãŸã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ)
    """
    pass
```

## ğŸ—‚ï¸ ãƒ•ã‚¡ã‚¤ãƒ«åˆ¥ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°è¨ˆç”»

### Priority 1: ç·Šæ€¥å¯¾å¿œãŒå¿…è¦

#### src/pkg/memo_logic/dag_integration.py
- [ ] **éšå±¤æ§‹é€ ã®ä¿®æ­£**
  - [ ] 3éšå±¤å›ºå®šã‹ã‚‰å‹•çš„éšå±¤ã«å¤‰æ›´
  - [ ] éšå±¤1-3 â†’ ç´ æDAGï¼ˆéšå±¤0-5ï¼‰
  - [ ] DAGNodeã‚¯ãƒ©ã‚¹ã®éšå±¤å‚ç…§ãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½è¿½åŠ 

- [ ] **ã‚¹ãƒ†ãƒ¼ãƒˆãƒ¬ã‚¹åŒ–**
  - [ ] FunctionalDAGEngineã‚¯ãƒ©ã‚¹ã®è§£ä½“
  - [ ] ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å¤–éƒ¨æ³¨å…¥ã«å¤‰æ›´
  - [ ] å±¥æ­´ç®¡ç†ã‚’å¤–éƒ¨ã«ç§»è­²

#### src/pkg/memo_logic/core_pkg_functions.py
- [ ] **é–¢æ•°å®šç¾©ã®æ¨™æº–åŒ–**
  - [ ] ç‹¬è‡ªé–¢æ•°åã‚’PKG IDå½¢å¼ã«å¤‰æ›´
  - [ ] å…¥å‡ºåŠ›ã®å‹å®‰å…¨æ€§ç¢ºä¿
  - [ ] ç´”ç²‹é–¢æ•°ã¸ã®å¤‰æ›

#### src/pkg/memo_logic/raw_symbol_to_pkg.py
- [ ] **IDä½“ç³»ã®çµ±ä¸€**
  - [ ] AA/ABç³»è¨˜å·ã®å®Œå…¨å»ƒæ­¢
  - [ ] çµ±ä¸€PKG IDä½“ç³»ã¸ã®ç§»è¡Œ
  - [ ] å¤‰æ›ãƒ†ãƒ¼ãƒ–ãƒ«ã®æ›´æ–°

### Priority 2: æ®µéšçš„å¯¾å¿œ

#### src/pkg/memo_logic/pkg_function_manager.py
- [ ] **ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£é©åˆ**
  - [ ] 4æ®µéšDAGæ§‹é€ ã«å¯¾å¿œ
  - [ ] å„DAGç¨®åˆ¥ã®ç®¡ç†æ©Ÿèƒ½è¿½åŠ 
  - [ ] ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ/ã‚¤ãƒ³ãƒãƒ¼ãƒˆå¥‘ç´„ã®å®Ÿè£…

#### src/pkg/memo_logic/dag_engine_v2.py
- [ ] **ã‚¨ãƒ³ã‚¸ãƒ³ã®åˆ†é›¢**
  - [ ] ç´ æDAGã‚¨ãƒ³ã‚¸ãƒ³
  - [ ] åˆ¤å®šDAGã‚¨ãƒ³ã‚¸ãƒ³
  - [ ] è²¡å‹™DAGã‚¨ãƒ³ã‚¸ãƒ³
  - [ ] å–å¼•DAGã‚¨ãƒ³ã‚¸ãƒ³

### Priority 3: æ®µéšçš„çµ±åˆ

#### ãã®ä»–ã®ãƒ•ã‚¡ã‚¤ãƒ«
- [ ] ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®PKGæº–æ‹ åŒ–
- [ ] ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°ã®æ•´ç†
- [ ] ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®æ›´æ–°

## ğŸ—ï¸ æ–°ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ã®æ§‹ç¯‰

### Phase 1: ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
```bash
mkdir -p src/pkg/feature_dag
mkdir -p src/pkg/decision_dag/timeframes
mkdir -p src/pkg/financial_dag
mkdir -p src/pkg/trading_dag
mkdir -p tests/pkg/{feature,decision,financial,trading}
```

### Phase 2: åŸºæœ¬ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
- [ ] **ç´ æDAG**
  - [ ] `src/pkg/feature_dag/__init__.py`
  - [ ] `src/pkg/feature_dag/data_collection.py`
  - [ ] `src/pkg/feature_dag/feature_extraction.py`
  - [ ] `src/pkg/feature_dag/export_layer.py`

- [ ] **åˆ¤å®šDAGç¾¤**
  - [ ] `src/pkg/decision_dag/timeframes/m1_decision.py`
  - [ ] `src/pkg/decision_dag/timeframes/m5_decision.py`
  - [ ] `src/pkg/decision_dag/timeframes/m15_decision.py`
  - [ ] `src/pkg/decision_dag/timeframes/h1_decision.py`
  - [ ] `src/pkg/decision_dag/timeframes/h4_decision.py`

- [ ] **è²¡å‹™DAG**
  - [ ] `src/pkg/financial_dag/risk_management.py`
  - [ ] `src/pkg/financial_dag/position_sizing.py`

- [ ] **å–å¼•DAG**
  - [ ] `src/pkg/trading_dag/signal_integration.py`

## ğŸ§ª ãƒ†ã‚¹ãƒˆæˆ¦ç•¥

### 1. PKGæº–æ‹ ãƒ†ã‚¹ãƒˆ
```python
# tests/pkg/test_pkg_compliance.py

def test_no_horizontal_references():
    """æ¨ªå‚ç…§ãŒãªã„ã“ã¨ã‚’ç¢ºèª"""
    for node_id, node in dag.nodes.items():
        for dep in node.dependencies:
            dep_node = dag.nodes[dep]
            assert dep_node.hierarchy < node.hierarchy

def test_stateless_functions():
    """ç´”ç²‹é–¢æ•°ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª"""
    # åŒã˜å…¥åŠ›ã§è¤‡æ•°å›å®Ÿè¡Œã—ã¦çµæœãŒåŒã˜ã‹ç¢ºèª
    pass

def test_pkg_id_format():
    """PKG IDå½¢å¼ã®æ­£ã—ã•ã‚’ç¢ºèª"""
    import re
    pattern = r'^\d\d\d\^\d+-\d+$'
    for node_id in dag.nodes.keys():
        assert re.match(pattern, node_id)
```

### 2. æ€§èƒ½ãƒ†ã‚¹ãƒˆ
```python
# tests/pkg/test_performance.py

def test_response_time():
    """30msä»¥å†…ã®å¿œç­”ã‚’ç¢ºèª"""
    start_time = time.time()
    result = execute_dag(test_data)
    execution_time = (time.time() - start_time) * 1000
    assert execution_time < 30  # 30ms
```

### 3. çµ±åˆãƒ†ã‚¹ãƒˆ
```python
# tests/pkg/test_integration.py

def test_dag_pipeline():
    """4æ®µéšDAGã®çµ±åˆå‹•ä½œã‚’ç¢ºèª"""
    # ç´ æDAG â†’ åˆ¤å®šDAG â†’ è²¡å‹™DAG â†’ å–å¼•DAG
    pass
```

## ğŸ“ ç§»è¡Œæ‰‹é †

### Week 1: ç·Šæ€¥å¯¾å¿œ

#### Day 1-2: æ¨ªå‚ç…§ã®æ’é™¤
1. [ ] æ¨ªå‚ç…§ç®‡æ‰€ã®ç‰¹å®šï¼ˆdependency graphåˆ†æï¼‰
2. [ ] ä¿®æ­£è¨ˆç”»ã®ä½œæˆ
3. [ ] ç·Šæ€¥ä¿®æ­£ã®å®Ÿè£…

#### Day 3-4: ã‚¹ãƒ†ãƒ¼ãƒˆãƒ¬ã‚¹åŒ–
1. [ ] ã‚¹ãƒ†ãƒ¼ãƒˆãƒ•ãƒ«å®Ÿè£…ã®ç‰¹å®š
2. [ ] ç´”ç²‹é–¢æ•°ã¸ã®å¤‰æ›
3. [ ] ã‚­ãƒ£ãƒƒã‚·ãƒ¥å¤–éƒ¨åŒ–

#### Day 5: æ–°æ§‹é€ æº–å‚™
1. [ ] æ–°ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ã®ä½œæˆ
2. [ ] åŸºæœ¬ãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ
3. [ ] ç§»è¡Œè¨ˆç”»ã®è©³ç´°åŒ–

### Week 2: æ§‹é€ å†ç·¨

#### Day 1-2: ç´ æDAGç§»è¡Œ
1. [ ] ãƒ‡ãƒ¼ã‚¿åé›†å±¤ã®å®Ÿè£…
2. [ ] ç‰¹å¾´é‡æŠ½å‡ºå±¤ã®å®Ÿè£…
3. [ ] ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå±¤ã®å®Ÿè£…

#### Day 3-4: åˆ¤å®šDAGéª¨çµ„ã¿
1. [ ] å„æ™‚é–“è¶³åˆ¤å®šDAGã®åŸºæœ¬æ§‹é€ 
2. [ ] ãƒ¡ãƒ¢ãƒ­ã‚¸ãƒƒã‚¯ã®åˆ†é›¢
3. [ ] ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹å®šç¾©

#### Day 5: çµ±åˆãƒ†ã‚¹ãƒˆ
1. [ ] ãƒ†ã‚¹ãƒˆå®Ÿè£…
2. [ ] çµ±åˆå‹•ä½œç¢ºèª
3. [ ] ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¸¬å®š

## ğŸš¨ ãƒªã‚¹ã‚¯å¯¾ç­–

### 1. æ©Ÿèƒ½ç ´å£Šã®é˜²æ­¢
- [ ] **ä¸¦è¡Œé‹ç”¨**
  - [ ] æ–°æ—§ã‚·ã‚¹ãƒ†ãƒ ã®ä¸¦è¡Œå®Ÿè¡Œ
  - [ ] çµæœã®æ¯”è¼ƒæ¤œè¨¼
  - [ ] æ®µéšçš„åˆ‡ã‚Šæ›¿ãˆ

- [ ] **ãƒ†ã‚¹ãƒˆé§†å‹•**
  - [ ] æ—¢å­˜æ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆä½œæˆ
  - [ ] ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°å‰å¾Œã®å‹•ä½œæ¯”è¼ƒ
  - [ ] å›å¸°ãƒ†ã‚¹ãƒˆã®å®Ÿæ–½

### 2. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ä¿è¨¼
- [ ] **ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯**
  - [ ] ç¾åœ¨ã®æ€§èƒ½æ¸¬å®š
  - [ ] ç›®æ¨™æ€§èƒ½ã®è¨­å®šï¼ˆ30msä»¥å†…ï¼‰
  - [ ] ç¶™ç¶šçš„ãªãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°

### 3. å“è³ªä¿è¨¼
- [ ] **ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼**
  - [ ] PKGæº–æ‹ æ€§ã®ç¢ºèª
  - [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç¢ºèª
  - [ ] å¯èª­æ€§ç¢ºèª

## âœ… å®Œäº†æ¡ä»¶

### Phase 1å®Œäº†ã®åˆ¤å®šåŸºæº–
- [ ] æ¨ªå‚ç…§ãŒå®Œå…¨ã«æ’é™¤ã•ã‚Œã¦ã„ã‚‹
- [ ] ã™ã¹ã¦ã®é–¢æ•°ãŒã‚¹ãƒ†ãƒ¼ãƒˆãƒ¬ã‚¹
- [ ] PKG IDä½“ç³»ãŒçµ±ä¸€ã•ã‚Œã¦ã„ã‚‹
- [ ] åŸºæœ¬çš„ãªãƒ†ã‚¹ãƒˆãŒé€šé
- [ ] æ–°ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ãŒæ•´å‚™ã•ã‚Œã¦ã„ã‚‹

### æ¬¡ãƒ•ã‚§ãƒ¼ã‚ºã¸ã®ç§»è¡Œæ¡ä»¶
- [ ] å…¨ãƒã‚§ãƒƒã‚¯é …ç›®ã®80%ä»¥ä¸ŠãŒå®Œäº†
- [ ] ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆãŒé€šé
- [ ] çµ±åˆãƒ†ã‚¹ãƒˆãŒé€šé
- [ ] ã‚¹ãƒ†ãƒ¼ã‚¯ãƒ›ãƒ«ãƒ€ãƒ¼ã®æ‰¿èªå–å¾—

---

æœ€çµ‚æ›´æ–°: 2025å¹´1æœˆ
ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆè²¬ä»»è€…: PKG DAGãƒãƒ¼ãƒ 